# 個人データインポート仕様書

本書は Wikipage コンテンツから Person（個人）データをインポートする際のフォーマットとロジックについて記述します。

## 概要

`PersonImporter` サービスは、レガシーな Wikipage テキストを解析し、`Person` レコードおよびその関連データ（`UnitPerson`, `TagIndex`, `PersonLink`）を作成または更新します。

## 判定基準

以下のカテゴリを含む Wikipage は Person とみなされます：
- `{{category 個人`

## 個人名と改名履歴 (Name Log)

インポーターは **Wiki タイトル** および Wiki コンテンツの **1行目** を解析します。

### フォーマット
1. **タイトル**: `名前` または `名前(かな)`
2. **履歴行 (1行目)**: `旧名(かな) → 新名(かな)`
   - `name_log` の生成に使用されます。
   - 最後の名前が現在の名前として使用されます。

### サポートされる構文
- `{{rb 名前,かな}}`: ルビ構文

## キー生成 (Key Generation)

URLスラッグとなる `key` は以下に基づいて生成されます：
1. ASCII Wiki名（該当する場合）
2. かな読みから変換されたローマ字
3. エンコードされた EUC-JP 文字列（フォールバック）

### 誕生日サフィックス
誕生日が（カテゴリ経由で）判明している場合、キーの末尾に追加されます：
- フォーマット: `base-key-MMDD`
- 例: `tosh-1004`

## カテゴリと属性

構文: `{{category タグ名}}`

カテゴリは `Person` の属性および `TagIndex` レコードの設定に使用されます。

### 属性マッピング
| カテゴリ書式 | 属性 | 備考 |
|---|---|---|
| `誕生日/MM/DD` | `birthday` | 年はデフォルトで 1904 (うるう年対応ダミー) |
| `誕生年/YYYY` | `birth_year` | |
| `誕生年/不明` | `birth_year` | `nil` (不明) に設定 |
| `血液型/X` | `blood` | A, B, O, AB |
| `血液型/不明` | `blood` | "Unknown" |
| `出身地/場所` | `hometown` | |

### ステータスマッピング
| カテゴリ | ステータス |
|---|---|
| `死去` | `:passed_away` |
| `個人/状況不明` | `:unknown` |
| `引退` | `:retirement` |
| `個人/フリー` | `:free` |
| (上記以外) | `:active` |

### タグ
誕生日・誕生年を除くすべてのカテゴリは `TagIndex` レコードとしても保存され、`TagIndexItem` 経由でリンクされます。
- タグの `index_group_id` はデフォルトで `2` です。

## リンク (`PersonLink`)

`!!リンク` セクションから解析されます。
- Unit リンクと同じロジック (`[[Service:Account]]`, `[Label|URL]`, `{{outlink}}`) が使用されます。

## 経歴 (`UnitPerson`)

`!!経歴` セクションから解析されます。

### フォーマット
- 生のテキストは `old_history` に保存されます。
- `→ [[UnitName]](Part)` 構文が解析され、`UnitPerson` レコードが作成されます。
  - リンク先の Unit が存在する必要があります。
  - ステータスは `:left` (過去の所属) に設定されます。
