# ユニットデータインポート仕様書

本書は Wikipage コンテンツから Unit（ユニット）データをインポートする際のフォーマットとロジックについて記述します。

## 概要

`WikipageImporter` サービスは、レガシーな Wikipage テキストを解析し、`Unit` レコードおよびその関連データ（`Person`, `UnitPerson`, `TagIndex`, `UnitLink`）を作成または更新します。

## 判定基準

以下のいずれかを含む Wikipage は Unit とみなされます：
- `{{member...}}` プラグインタグが含まれている
- または、`!Part… [[` （旧メンバーフォーマット）で始まる行がある

## ユニット名と改名履歴 (Name Log)

インポーターは Wiki コンテンツの **1行目** を解析し、ユニット名、読み仮名、改名履歴を特定します。

### フォーマット
1. **履歴付きフォーマット**: `旧名称(かな) → 新名称(かな)`
   - 最後の要素が現在の Unit 名として使用されます。
   - それより前の要素は `name_log` に保存されます。
2. **シンプルフォーマット**: `名称(かな)`
3. **フォールバック**: Wikipage のタイトルを使用します。

### サポートされる構文
- `{{rb 名称,かな}}`: ルビ構文
- `名称(かな)`: 丸括弧による読み仮名
- `[[表示名|リンク]]` または `[[リンク]]`: Wikiリンクは除去され、名称のみが抽出されます。

## キー生成 (Key Generation)

URLスラッグとなる `key` は、以下の優先順位で生成されます：
1. ASCII Wiki名（該当する場合）
2. かな読みから変換されたローマ字
3. エンコードされた EUC-JP 文字列（ASCII/かな以外の場合のフォールバック）

キーは正規化されます：
- 小文字化
- 英数字以外の文字（ハイフンを除く）を `-` に置換
- 重複がある場合は末尾に `-2`, `-3` などのサフィックスを付与

## カテゴリ (タグ)

構文: `{{category タグ名}}`

- 解析されたタグは `TagIndex` レコードとして保存されます。
- `TagIndexItem` を介して Unit に紐付けられます。
- タグの `index_group_id` はデフォルトで `1` です。

## メンバー (`UnitPerson`)

メンバーセクションでユニットのラインナップを定義します。

### セクション区切り
`!!関係者` で始まる行がセパレータとして機能します。
- この行より **上** （または行がない場合）のメンバーは **Active**（現役）です。
- この行より **下** のメンバーは **Left**（脱退済/元メンバー）です。

### フォーマット

#### 1. メンバープラグイン
構文: `{{member パート, 名前, 旧キー, SNS}}`

- **パート**: Vocal, Guitar, Bass, Drums, etc.
- **名前**: メンバー名
- **旧キー**: 任意。レガシーリンク用に使用されます。
- **SNS**: 任意。SNSアカウントハンドル。

#### 2. 旧フォーマット
構文: `!パート… [[名前|旧キー]]`

### ロジック
- `key` または `name` に基づいて `Person` レコードを検索または作成します。
- `UnitPerson` 関連付けを作成します。
- `旧キー` が提供された場合、`old_person_key` に保存されます。

## リンク (`UnitLink`)

`!!リンク` セクションから解析されます。

### フォーマット
- `[[Service:Account]]`: 特定のサービス（Twitter, YouTubeなど）へのマッピング。
- `[ラベル|URL]`: 汎用的な外部リンク。
- `{{outlink Type}}`: 特殊な外部リンク（dw, it, tunecore）。
- `{{unlink ...}}`: 非アクティブ（リンク切れ/過去）のリンク。

## ユニットタイプ
- デフォルトは `:band` です。
- `{{category セッションバンド}}` が存在する場合、タイプは `:session` に設定されます。
